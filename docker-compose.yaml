# ========================================
# Bebee 개발 환경 Docker Compose 설정
# ========================================
#
# 이 파일은 Bebee 개발에 필요한 인프라 서비스들을 정의합니다.
# MySQL과 Redis를 Docker 컨테이너로 실행하여 개발 환경을 구성합니다.
#
# 환경 변수 사용:
# - .env 파일에서 환경 변수를 읽어와서 사용
# - 환경 변수가 없으면 기본값 사용
#
# 실행 방법:
#   docker-compose up -d    # 백그라운드에서 실행
#   docker-compose down     # 컨테이너 중지 및 삭제
#   docker-compose logs     # 로그 확인

# Docker Compose 버전
version: '3.8'

# 프로젝트 이름 지정
name: bebee

# 서비스 정의
services:
  # ========================================
  # MySQL 데이터베이스 서비스
  # ========================================
  mysql:
    image: mysql:8.0
    container_name: mysql-db
    environment:
      # 환경 변수 설정 (.env 파일에서 읽어오거나 기본값 사용)
      MYSQL_ROOT_PASSWORD: ${DB_ROOT_PASSWORD:-root1234}      # MySQL root 사용자 비밀번호
      MYSQL_USER: ${DB_USERNAME:-bebee}                    # 생성할 사용자 이름
      MYSQL_PASSWORD: ${DB_PASSWORD:-bebee1234}            # 생성할 사용자 비밀번호
    ports:
      - "3306:3306"
    volumes:
      # 데이터 영속성
      - mysql_data:/var/lib/mysql
      # 초기화 스크립트 마운트
      - ./docker/mysql/init:/docker-entrypoint-initdb.d
    networks:
      - bebee-network

  # ========================================
  # Redis 데이터베이스 서비스
  # ========================================
  redis:
    image: redis:6.2-alpine
    container_name: redis-db
    restart: always
    ports:
      - "6379:6379"
    volumes:
      # 데이터 영속성
      - redis_data:/data
    networks:
      - bebee-network

  # ========================================
  # MongoDB 데이터베이스 서비스
  # ========================================
  mongodb:
    image: mongo:8.0
    container_name: mongo-db
    environment:
      MONGO_INITDB_ROOT_USERNAME: bebee
      MONGO_INITDB_ROOT_PASSWORD: bebee1234
    ports:
      - "27017:27017"
    volumes:
      - mongo_data:/data/db
    networks:
      - bebee-network

  # ========================================
  # LocalStack 서비스
  # ========================================
  localstack:
    container_name: localstack
    image: localstack/localstack:3
    ports:
      - "4566:4566" # LocalStack Gateway (모든 AWS 서비스)
#      - "4510-4559:4510-4559" # 필요하다면
    environment:
      - AWS_DEFAULT_REGION=ap-northeast-2
      - SERVICES=sqs,sns,s3
      - DATA_DIR=/tmp/localstack/data
      - DEBUG=1
      - DOCKER_HOST=unix:///var/run/docker.sock
      - EAGER_SERVICE_LOADING=1
    volumes:
      - localstack_data:/var/lib/localstack
      - "/var/run/docker.sock:/var/run/docker.sock"
      - "./docker/localstack/init:/etc/localstack/init/ready.d"
    networks:
      - bebee-network

# ========================================
# 볼륨 정의 (Volumes)
# ========================================
volumes:
  mysql_data:
  redis_data:
  mongo_data:
  localstack_data:

# ========================================
# 네트워크 정의 (Networks)
# ========================================
networks:
  bebee-network:
    driver: bridge
